@startuml
actor کاربر
participant "InvoiceView" as View
participant "InvoiceViewModel" as VM
participant "InvoiceService" as Serv
participant "ModianIntegrationService" as Modian
participant "API معتمد (ماهر/مالیتور)" as API
participant "سامانه مودیان" as Tax

کاربر -> View : صدور فاکتور + کلیک "ارسال به مودیان"
View -> VM : SendToModianCommand.Execute()
VM -> Serv : GenerateModianPayload(invoice)
Serv --> VM : JSON/XML آماده
VM -> Modian : SendInvoiceAsync(payload)
Modian -> API : POST /invoices (با توکن)
API -> Tax : ارسال صورتحساب
Tax --> API : پاسخ (UID + وضعیت)
API --> Modian : { "uid": "...", "status": "SUCCESS" }
Modian --> VM : ModianInvoice (ذخیره در DB)
VM --> View : نمایش "ارسال موفق" + UID
View --> کاربر : نمایش پیام موفقیت

alt خطا در ارسال
  Modian --> VM : Exception (کد خطا)
  VM --> View : نمایش خطا + پیشنهاد retry
end
@enduml